#!/usr/bin/env sh

set -eu

# LD_PRELOAD に設定された共有ライブラリ（jemalloc 等）が Nix 環境と競合するため解除
unset LD_PRELOAD

echo "install スクリプト起動"

# curl がなければインストール
if ! command -v curl > /dev/null 2>&1; then
  echo "curl をインストール中..."
  if command -v apt-get > /dev/null 2>&1; then
    sudo apt-get update && sudo apt-get install -y curl
  elif command -v apk > /dev/null 2>&1; then
    sudo apk add curl
  else
    echo "パッケージマネージャーが見つかりません。curl をインストールできません。"
    exit 1
  fi
fi

# Nix がインストールされているか確認
if [ ! -d /nix ]; then
  echo "Nix をインストール中..."
  # systemd がないコンテナ環境のため --init none を指定
  curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --init none --no-confirm
fi

# Nix daemon を起動（--init none でインストールした場合は自動起動しないため）
if [ -d /nix ] && ! pgrep -x nix-daemon > /dev/null 2>&1; then
  echo "Nix daemon を起動中..."
  sudo /nix/var/nix/profiles/default/bin/nix-daemon &

  # daemon が応答するまで待機（最大30秒）
  echo "Nix daemon の起動を待機中..."
  for i in $(seq 1 30); do
    if /nix/var/nix/profiles/default/bin/nix store ping > /dev/null 2>&1; then
      echo "Nix daemon が起動しました"
      break
    fi
    if [ "$i" -eq 30 ]; then
      echo "警告: Nix daemon の起動がタイムアウトしました"
    fi
    sleep 1
  done
fi

# Nix の環境変数を読み込む
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
  . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

# 環境変数を設定（コンテナ環境で未設定の場合がある）
export USER="${USER:-quipper}"
export HOME="${HOME:-/home/quipper}"

# Nix が使用するディレクトリを作成
mkdir -p "$HOME/.cache/nix"
mkdir -p "$HOME/.config/nix"

# Nix ストア内の libstdc++ を探して LD_LIBRARY_PATH を設定
# Nix バイナリの起動に必要（NIX_LD 使用時にシステムライブラリを参照するため）
setup_nix_ld_libs() {
  echo "Nix ライブラリパスを設定中..."
  LIBSTDCPP=$(/usr/bin/find /nix/store -name "libstdc++.so.6" 2>/dev/null | /usr/bin/head -1)
  if [ -n "$LIBSTDCPP" ]; then
    LIBDIR=$(/usr/bin/dirname "$LIBSTDCPP")
    export LD_LIBRARY_PATH="$LIBDIR:/usr/lib/aarch64-linux-gnu:${LD_LIBRARY_PATH:-}"
    echo "  LD_LIBRARY_PATH に $LIBDIR を追加"

    # /etc/profile.d/ に永続設定を追加（ログイン時に自動適用）
    PROFILE_SCRIPT="/etc/profile.d/nix-ld-libs.sh"
    if [ ! -f "$PROFILE_SCRIPT" ] || ! grep -q "$LIBDIR" "$PROFILE_SCRIPT" 2>/dev/null; then
      echo "  $PROFILE_SCRIPT を作成中..."
      cat << EOF | sudo tee "$PROFILE_SCRIPT" > /dev/null
# Nix バイナリが必要とする libstdc++ へのパス
# NIX_LD 使用時にシステムの動的リンカーがこのパスを参照する
export LD_LIBRARY_PATH="$LIBDIR:/usr/lib/aarch64-linux-gnu:\$LD_LIBRARY_PATH"
EOF
      sudo chmod 644 "$PROFILE_SCRIPT"
    fi
  else
    echo "  警告: libstdc++.so.6 が見つかりません。初回ビルド後に再実行してください。"
    export LD_LIBRARY_PATH="/usr/lib/aarch64-linux-gnu:${LD_LIBRARY_PATH:-}"
  fi
}

setup_nix_ld_libs

# home-manager 設定リポジトリの準備
HM_DIR="$HOME/.config/home-manager"
if [ ! -d "$HM_DIR" ]; then
  echo "home-manager 設定を clone 中..."
  git clone https://github.com/YutaUra/nix-darwin.git "$HM_DIR"
else
  echo "home-manager 設定を更新中..."
  git -C "$HM_DIR" pull
fi

# home-manager を適用
echo "home-manager を適用中..."
nix run home-manager -- switch --flake "$HM_DIR#qall-k8s" -b backup

# home-manager 適用後、libstdc++ のパスが変わった可能性があるため再設定
setup_nix_ld_libs

echo "セットアップ完了"
